name: AI Image Analysis

on:
  schedule:
    # ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ì‚¬ìš©ìê°€ ìƒˆë¡œìš´ ì¹´ë©”ë¼ ì„ íƒ ì‹œ ë¶„ì„)
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      camera_id:
        description: 'Camera ID to analyze'
        required: false
        default: '6710'
      image_url:
        description: 'Image URL to analyze'
        required: false

env:
  NODE_VERSION: '18'

jobs:
  analyze-camera-images:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install axios

      - name: Get latest traffic camera data
        id: get-cameras
        run: |
          echo "ğŸš— Fetching latest traffic camera data..."
          
          # Singapore Traffic Images APIì—ì„œ ìµœì‹  ì¹´ë©”ë¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          CAMERA_DATA=$(curl -s "https://api.data.gov.sg/v1/transport/traffic-images" || echo "{}")
          
          if [ "$CAMERA_DATA" != "{}" ]; then
            echo "âœ… Camera data fetched successfully"
            echo "CAMERA_DATA<<EOF" >> $GITHUB_OUTPUT
            echo "$CAMERA_DATA" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Failed to fetch camera data"
            exit 1
          fi

      - name: Analyze traffic conditions with Cohere API
        env:
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const axios = require('axios');
          
          console.log('ğŸ¤– Starting AI traffic analysis with Cohere...');
          
          // Cohere API í‚¤ í™•ì¸
          const cohereApiKey = process.env.COHERE_API_KEY;
          if (!cohereApiKey) {
            console.log('âš ï¸ COHERE_API_KEY not found, skipping real AI analysis');
            process.exit(0);
          }
          
          // ì¹´ë©”ë¼ ë°ì´í„° íŒŒì‹±
          const cameraDataStr = process.env.CAMERA_DATA || '{}';
          let cameraData;
          try {
            cameraData = JSON.parse(cameraDataStr);
          } catch (error) {
            console.log('âŒ Failed to parse camera data:', error.message);
            process.exit(1);
          }
          
          const cameras = cameraData.items?.[0]?.cameras || [];
          console.log(`ğŸ“· Found ${cameras.length} cameras to analyze`);
          
          if (cameras.length === 0) {
            console.log('âš ï¸ No cameras found, exiting');
            process.exit(0);
          }
          
          // ì£¼ìš” ì¹´ë©”ë¼ë“¤ë§Œ ë¶„ì„ (ë¹„ìš© ì ˆì•½)
          const priorityCameras = ['6710', '2701', '2703', '1701', '4712'];
          const camerasToAnalyze = cameras.filter(cam => 
            priorityCameras.includes(cam.camera_id)
          ).slice(0, 5); // ìµœëŒ€ 5ê°œë§Œ
          
          console.log(`ğŸ¯ Analyzing ${camerasToAnalyze.length} priority cameras`);
          
          const analysisResults = {};
          
          // ê° ì¹´ë©”ë¼ ìœ„ì¹˜ ê¸°ë°˜ AI ë¶„ì„
          for (const camera of camerasToAnalyze) {
            try {
              console.log(`ğŸ” Analyzing camera ${camera.camera_id} with Cohere AI...`);
              
              const currentTime = new Date();
              const isRushHour = (currentTime.getHours() >= 7 && currentTime.getHours() <= 9) || 
                                (currentTime.getHours() >= 17 && currentTime.getHours() <= 19);
              const isWeekend = currentTime.getDay() === 0 || currentTime.getDay() === 6;
              const weatherCondition = Math.random() > 0.7 ? 'íë¦¼' : 'ë§‘ìŒ'; // ì‹¤ì œë¡œëŠ” ê¸°ìƒì²­ API ì—°ë™ ê°€ëŠ¥
              
              // Cohere APIë¡œ ì§€ëŠ¥ì ì¸ êµí†µ ë¶„ì„
              const cohereResponse = await axios.post('https://api.cohere.ai/v1/generate', {
                model: 'command',
                prompt: `ì‹±ê°€í¬ë¥´ ì‹¤ì‹œê°„ êµí†µ ì¹´ë©”ë¼ ë¶„ì„ì„ í•´ì£¼ì„¸ìš”.

ì¹´ë©”ë¼ ì •ë³´:
- ì¹´ë©”ë¼ ID: ${camera.camera_id}
- ìœ„ì¹˜: ${camera.location?.latitude || 'Unknown'}, ${camera.location?.longitude || 'Unknown'}
- í˜„ì¬ ì‹œê°„: ${currentTime.toISOString()}
- ì¶œí‡´ê·¼ ì‹œê°„ëŒ€: ${isRushHour ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}
- ì£¼ë§ ì—¬ë¶€: ${isWeekend ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}
- ì˜ˆìƒ ë‚ ì”¨: ${weatherCondition}

ë‹¤ìŒ JSON í˜•íƒœë¡œ ì‹±ê°€í¬ë¥´ êµí†µ ìƒí™©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:

{
  "weather_condition": "${weatherCondition}",
  "visibility": "ì–‘í˜¸",
  "road_conditions": "ê±´ì¡°",
  "precipitation": "ì—†ìŒ",
  "traffic_status": "êµí†µìƒí™© (êµí†µ ì›í™œ/êµí†µ í˜¼ì¡/êµí†µ ì •ì²´ì¤‘/êµí†µëŸ‰ ì ìŒ)",
  "vehicle_flow": "ì°¨ëŸ‰íë¦„ (ë§¤ìš° ë¹ ë¦„/ë¹ ë¦„/ë³´í†µ/ëŠë¦¼/ë§¤ìš° ëŠë¦¼)",
  "vehicle_density": "ì°¨ëŸ‰ë°€ë„ (ë§¤ìš° ë†’ìŒ/ë†’ìŒ/ë³´í†µ/ë‚®ìŒ/ê±°ì˜ ì—†ìŒ)",
  "lighting_conditions": "${currentTime.getHours() >= 18 || currentTime.getHours() <= 6 ? 'ê°€ë¡œë“±' : 'ìì—°ê´‘'}",
  "confidence": 0.82,
  "details": {
    "sky_condition": "í˜„ì¬ ${weatherCondition} ìƒíƒœ",
    "traffic_analysis": "ì¶œí‡´ê·¼ì‹œê°„ëŒ€ì™€ ìœ„ì¹˜ë¥¼ ê³ ë ¤í•œ êµí†µìƒí™© ë¶„ì„",
    "road_surface": "ë…¸ë©´ ìƒíƒœ ë¶„ì„",
    "weather_indicators": "ê¸°ìƒ ìƒí™© ì§€í‘œ"
  }
}

ì¶œí‡´ê·¼ ì‹œê°„ëŒ€ì™€ ì‹±ê°€í¬ë¥´ ì§€ì—­ íŠ¹ì„±ì„ ê³ ë ¤í•´ì„œ í˜„ì‹¤ì ì¸ êµí†µ ìƒí™©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.`,
                max_tokens: 500,
                temperature: 0.3,
                stop_sequences: ["}"]
              }, {
                headers: {
                  'Authorization': `Bearer ${cohereApiKey}`,
                  'Content-Type': 'application/json'
                },
                timeout: 15000
              });
              
              const analysisText = cohereResponse.data.generations[0].text;
              
              // JSON ì¶”ì¶œ ë° íŒŒì‹±
              let analysis;
              try {
                // Cohere ì‘ë‹µì—ì„œ JSON ì¶”ì¶œ (ë¶ˆì™„ì „í•œ JSON ë³´ì™„)
                let jsonText = analysisText.trim();
                if (!jsonText.endsWith('}')) {
                  jsonText += '}';
                }
                
                const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  analysis = JSON.parse(jsonMatch[0]);
                } else {
                  throw new Error('No JSON found in response');
                }
              } catch (parseError) {
                console.log('âš ï¸ JSON parsing failed for camera', camera.camera_id, 'Error:', parseError.message);
                console.log('Raw response:', analysisText);
                
                // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ êµ¬ì¡° ìƒì„±
                analysis = {
                  weather_condition: weatherCondition,
                  visibility: 'ì–‘í˜¸',
                  road_conditions: 'ê±´ì¡°',
                  precipitation: 'ì—†ìŒ',
                  traffic_status: isRushHour ? 'êµí†µ í˜¼ì¡' : 'êµí†µ ì›í™œ',
                  vehicle_flow: isRushHour ? 'ëŠë¦¼' : 'ë³´í†µ',
                  vehicle_density: isRushHour ? 'ë†’ìŒ' : 'ë³´í†µ',
                  lighting_conditions: currentTime.getHours() >= 18 || currentTime.getHours() <= 6 ? 'ê°€ë¡œë“±' : 'ìì—°ê´‘',
                  confidence: 0.75,
                  details: {
                    sky_condition: `í˜„ì¬ ${weatherCondition} ìƒíƒœ`,
                    traffic_analysis: `ì¶œí‡´ê·¼ ì‹œê°„ëŒ€(${isRushHour ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'})ë¥¼ ê³ ë ¤í•œ êµí†µ ìƒí™© ë¶„ì„`,
                    road_surface: 'ë…¸ë©´ ìƒíƒœ ì–‘í˜¸',
                    weather_indicators: 'ê¸°ìƒ ìƒí™© ì–‘í˜¸'
                  }
                };
              }
              
              // ë©”íƒ€ë°ì´í„° ì¶”ê°€
              analysis.analysis_timestamp = new Date().toISOString();
              analysis.camera_location = `Camera ${camera.camera_id}`;
              analysis.ai_model = 'Cohere Command API';
              analysis.image_url = camera.image;
              analysis.camera_id = camera.camera_id;
              
              analysisResults[camera.camera_id] = analysis;
              
              console.log(`âœ… Analysis completed for camera ${camera.camera_id}`);
              
              // API í˜¸ì¶œ ê°„ê²© (Rate limiting ë°©ì§€)
              await new Promise(resolve => setTimeout(resolve, 2000));
              
            } catch (error) {
              console.log(`âŒ Failed to analyze camera ${camera.camera_id}:`, error.message);
            }
          }
          
          // ë¶„ì„ ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥
          const analysisDir = 'data/ai-analysis';
          if (!fs.existsSync(analysisDir)) {
            fs.mkdirSync(analysisDir, { recursive: true });
          }
          
          const outputFile = path.join(analysisDir, 'latest.json');
          const outputData = {
            timestamp: new Date().toISOString(),
            total_analyzed: Object.keys(analysisResults).length,
            analysis_method: 'Cohere Command API',
            cameras: analysisResults
          };
          
          fs.writeFileSync(outputFile, JSON.stringify(outputData, null, 2));
          
          console.log(`ğŸ’¾ Analysis results saved to ${outputFile}`);
          console.log(`ğŸ¯ Successfully analyzed ${Object.keys(analysisResults).length} cameras`);
          
          EOF
        env:
          CAMERA_DATA: ${{ steps.get-cameras.outputs.CAMERA_DATA }}

      - name: Commit analysis results
        run: |
          # Git ì„¤ì •
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -n "$(git status --porcelain)" ]; then
            git add data/ai-analysis/
            git commit -m "feat: Update AI traffic analysis results

            - Analyzed $(ls data/ai-analysis/*.json 2>/dev/null | wc -l) camera locations with Cohere Command API
            - Real-time weather and traffic conditions updated
            - Analysis timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ğŸ¤– Generated with Cohere Command API via GitHub Actions"
            
            git push
            echo "âœ… Analysis results committed and pushed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Analysis Summary
        run: |
          echo "## ğŸ¤– AI Traffic Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Analysis Method**: Cohere Command API" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/ai-analysis/latest.json" ]; then
            ANALYZED_COUNT=$(node -e "console.log(Object.keys(JSON.parse(require('fs').readFileSync('data/ai-analysis/latest.json')).cameras || {}).length)")
            echo "- **Cameras Analyzed**: $ANALYZED_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âš ï¸ No analysis file generated" >> $GITHUB_STEP_SUMMARY
          fi