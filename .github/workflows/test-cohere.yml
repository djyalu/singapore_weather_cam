name: Test Cohere API

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: 
      - '.github/workflows/test-cohere.yml'

jobs:
  test-cohere:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Test Cohere API
        env:
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          
          console.log('🧪 Testing Cohere API integration...');
          
          const cohereApiKey = process.env.COHERE_API_KEY;
          if (!cohereApiKey) {
            console.log('❌ COHERE_API_KEY not found');
            process.exit(1);
          }
          
          console.log('✅ COHERE_API_KEY found');
          console.log('Key length:', cohereApiKey.length);
          console.log('Key prefix:', cohereApiKey.substring(0, 10) + '...');
          
          // Create test data
          const testData = {
            timestamp: new Date().toISOString(),
            test: 'success',
            cohere_api_available: true
          };
          
          // Ensure directory exists
          if (!fs.existsSync('data')) {
            fs.mkdirSync('data', { recursive: true });
          }
          if (!fs.existsSync('data/ai-analysis')) {
            fs.mkdirSync('data/ai-analysis', { recursive: true });
          }
          
          // Write test file
          fs.writeFileSync('data/ai-analysis/test.json', JSON.stringify(testData, null, 2));
          
          console.log('📄 Test file created successfully');
          EOF

      - name: Commit test results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add data/ai-analysis/test.json
            git commit -m "test: Cohere API key validation successful"
            git push
            echo "✅ Test results committed"
          else
            echo "ℹ️ No changes to commit"
          fi